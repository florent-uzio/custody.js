name: Sync Acacia Branch

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: read

jobs:
  sync-acacia:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install

      - name: Build project
        run: npm run build

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # Configure the token for authentication
          git config --global credential.helper store
          echo "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com" > ~/.git-credentials

      - name: Checkout acacia branch
        run: |
          git fetch origin acacia:acacia
          git checkout acacia

      - name: Create acacia-specific .gitignore
        run: |
          # Create a .gitignore that doesn't ignore the dist directory for acacia branch
          cat > .gitignore << 'EOF'
          # Dependencies
          node_modules/
          npm-debug.log*
          yarn-debug.log*
          yarn-error.log*
          package-lock.json
          yarn.lock

          # Build outputs (commented out for acacia branch to allow dist in repo)
          # dist/
          # build/
          *.tsbuildinfo

          # Environment variables
          .env
          .env.local
          .env.*.local

          # IDE and editor files
          .idea/
          .vscode/
          *.swp
          *.swo
          .DS_Store
          Thumbs.db

          # Test coverage
          coverage/

          # Logs
          logs/
          *.log

          # Temporary files
          tmp/
          temp/

          # Optional npm cache directory
          .npm

          # Optional eslint cache
          .eslintcache

          # Optional REPL history
          .node_repl_history

          # Output of 'npm pack'
          *.tgz

          # Yarn Integrity file
          .yarn-integrity

          # dotenv environment variable files
          .env.development.local
          .env.test.local
          .env.production.local

          # Misc
          .DS_Store
          .env.local
          .env.development.local
          .env.test.local
          .env.production.local

          # Local testing files
          main.ts
          EOF

      - name: Merge main into acacia
        run: |
          # Add the current changes (including the new .gitignore and built dist)
          git add -A

          # Commit the current state
          git commit -m "Update acacia branch with latest build and .gitignore configuration"

          # Merge main branch
          git merge main --no-edit || {
            echo "Merge conflict detected, resolving..."
            # If there's a conflict, we'll resolve it by keeping our version
            git status --porcelain | grep "^UU" | cut -c4- | while read file; do
              echo "Resolving conflict in $file"
              git checkout --ours "$file"
              git add "$file"
            done
            git commit -m "Resolve merge conflicts, keeping acacia branch configuration"
          }

      - name: Push to acacia branch
        run: git push origin acacia
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
